<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Football Dice Game - Multiplayer</title>
  <style>
    /* Global reset and layout */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #1a472a;
      color: #fff;
      padding: 16px;
      line-height: 1.5;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }

    /* Lobby screen */
    .lobby {
      background: #0d2818;
      border: 2px solid #2d5a3d;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
    }

    .lobby h2 {
      margin-bottom: 20px;
      font-size: 22px;
    }

    .lobby-input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: 2px solid #2d5a3d;
      border-radius: 8px;
      background: #1a472a;
      color: #fff;
      margin-bottom: 12px;
      text-align: center;
      text-transform: uppercase;
    }

    .lobby-button {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .create-btn {
      background: #3b82f6;
      color: white;
    }

    .join-btn {
      background: #8b5cf6;
      color: white;
    }

    .room-code-display {
      background: #1a472a;
      border: 2px solid #4ade80;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .room-code-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .room-code {
      font-size: 48px;
      font-weight: bold;
      color: #4ade80;
      letter-spacing: 8px;
    }

    .waiting-message {
      font-size: 16px;
      opacity: 0.8;
      margin-top: 16px;
    }

    .api-key-setup {
      background: #7f1d1d;
      border: 2px solid #dc2626;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .api-key-setup h3 {
      margin-bottom: 12px;
      color: #fbbf24;
    }

    .api-key-setup p {
      font-size: 14px;
      margin-bottom: 8px;
      line-height: 1.6;
    }

    /* Score display */
    .scoreboard {
      background: #0d2818;
      border: 2px solid #2d5a3d;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }

    .score-item {
      flex: 1;
    }

    .score-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .score-value {
      font-size: 32px;
      font-weight: bold;
    }

    /* Game situation board */
    .situation-board {
      background: #0d2818;
      border: 2px solid #2d5a3d;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .situation-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .situation-item {
      background: #1a472a;
      border: 1px solid #2d5a3d;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }

    .situation-label {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .situation-value {
      font-size: 20px;
      font-weight: bold;
      color: #4ade80;
    }

    .situation-value.critical {
      color: #fbbf24;
    }

    .possession-info {
      text-align: center;
      padding: 10px;
      background: #1a472a;
      border-radius: 6px;
      font-size: 14px;
    }

    /* Visual field */
    .visual-field {
      background: #0d2818;
      border: 2px solid #2d5a3d;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .field-header {
      text-align: center;
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 12px;
    }

    .field-track {
      background: #1a472a;
      height: 60px;
      border-radius: 8px;
      position: relative;
      border: 2px solid #2d5a3d;
      overflow: hidden;
    }

    .field-markers {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
    }

    .field-marker {
      flex: 1;
      border-right: 1px solid #2d5a3d;
      position: relative;
    }

    .field-marker:last-child {
      border-right: none;
    }

    .marker-label {
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      opacity: 0.6;
    }

    .ball-marker {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 32px;
      height: 32px;
      background: #fbbf24;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: left 0.5s ease;
      border: 2px solid #92400e;
      z-index: 10;
    }

    .first-down-marker {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #fbbf24;
      z-index: 5;
      transition: left 0.5s ease;
    }

    .first-down-marker::before {
      content: '1st';
      position: absolute;
      top: 2px;
      left: 5px;
      font-size: 10px;
      color: #fbbf24;
      font-weight: bold;
    }

    .endzone {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 30px;
      background: repeating-linear-gradient(
        45deg,
        #4ade80,
        #4ade80 5px,
        #22c55e 5px,
        #22c55e 10px
      );
      opacity: 0.3;
    }

    /* Card selection sections */
    .card-section {
      margin-bottom: 20px;
    }

    .section-header {
      background: #0d2818;
      border: 2px solid #2d5a3d;
      border-radius: 8px 8px 0 0;
      padding: 12px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }

    .section-header.offense {
      background: #1e3a8a;
      border-color: #3b82f6;
    }

    .section-header.defense {
      background: #7f1d1d;
      border-color: #dc2626;
    }

    .section-header.my-role {
      box-shadow: 0 0 16px rgba(74, 222, 128, 0.4);
    }

    .cards-container {
      background: #0d2818;
      border: 2px solid #2d5a3d;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 12px;
    }

    .cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card {
      background: #1a472a;
      border: 3px solid #2d5a3d;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card:active {
      transform: scale(0.95);
    }

    .card.selected {
      border-color: #4ade80;
      background: #22543d;
      box-shadow: 0 0 12px rgba(74, 222, 128, 0.4);
    }

    .card.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-name {
      font-size: 15px;
      font-weight: bold;
    }

    .card-icon {
      font-size: 20px;
    }

    .card-stats {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .card-desc {
      font-size: 11px;
      opacity: 0.7;
      font-style: italic;
    }

    /* Ready button */
    .ready-button {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .ready-button.offense-ready {
      background: #3b82f6;
      color: white;
    }

    .ready-button.defense-ready {
      background: #dc2626;
      color: white;
    }

    .ready-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .ready-button.confirmed {
      background: #22c55e;
      color: white;
    }

    /* Status messages */
    .status-message {
      background: #1a472a;
      border: 2px solid #4ade80;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
    }

    .status-message.waiting {
      border-color: #fbbf24;
      color: #fbbf24;
    }

    /* Play button */
    .play-button {
      width: 100%;
      padding: 18px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.1s;
      background: #4ade80;
      color: #0d2818;
      margin-bottom: 12px;
    }

    .play-button:active {
      transform: scale(0.95);
    }

    .play-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #2d5a3d;
      color: #fff;
    }

    .reset-btn {
      background: #ef4444;
      color: white;
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Play log */
    .log-container {
      background: #0d2818;
      border: 2px solid #2d5a3d;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      opacity: 0.9;
    }

    .log-entry {
      background: #1a472a;
      border-left: 3px solid #4ade80;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      font-size: 14px;
    }

    .log-entry.touchdown {
      border-left-color: #fbbf24;
      background: #2d1f0a;
    }

    .log-entry.drive-end {
      border-left-color: #ef4444;
      background: #2d0a0a;
    }

    .log-entry.first-down {
      border-left-color: #3b82f6;
      background: #1e3a8a;
    }

    /* Game over message */
    .game-over {
      background: #1e3a8a;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .game-over h2 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #fbbf24;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ö° Football Dice Game ‚ö°</h1>

    <!-- API Key Setup Notice -->
    <div id="apiKeyNotice" class="api-key-setup">
      <h3>‚ö†Ô∏è Setup Required</h3>
      <p><strong>To enable multiplayer, you need a JSONBin API key:</strong></p>
      <p>1. Go to <a href="https://jsonbin.io" target="_blank" style="color: #4ade80;">jsonbin.io</a> and sign up (free)</p>
      <p>2. Get your API key from the dashboard</p>
      <p>3. Open this HTML file in a text editor</p>
      <p>4. Find line ~950: <code>const API_KEY = 'YOUR_API_KEY_HERE';</code></p>
      <p>5. Replace YOUR_API_KEY_HERE with your actual key</p>
      <p>6. Save and reload this page</p>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="lobby">
      <h2>Multiplayer Football</h2>
      
      <button class="lobby-button create-btn" onclick="createGame()">
        üéÆ Create New Game
      </button>
      
      <div style="margin: 20px 0; opacity: 0.6;">- OR -</div>
      
      <input 
        type="text" 
        id="joinCodeInput" 
        class="lobby-input" 
        placeholder="Enter 4-digit code"
        maxlength="4"
      />
      <button class="lobby-button join-btn" onclick="joinGame()">
        üîó Join Game
      </button>

      <div id="roomCodeDisplay" class="room-code-display hidden">
        <div class="room-code-label">Share this code with your friend:</div>
        <div class="room-code" id="roomCode">----</div>
        <div class="waiting-message">Waiting for opponent to join...</div>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden">
      <!-- Scoreboard -->
      <div class="scoreboard">
        <div class="score-item">
          <div class="score-label" id="player1Label">Player 1</div>
          <div class="score-value" id="score1">0</div>
        </div>
        <div class="score-item">
          <div class="score-label" id="player2Label">Player 2</div>
          <div class="score-value" id="score2">0</div>
        </div>
      </div>

      <!-- Status Message -->
      <div id="statusMessage" class="status-message hidden">
        Waiting for opponent...
      </div>

      <!-- Game Situation Board -->
      <div class="situation-board">
        <div class="situation-grid">
          <div class="situation-item">
            <div class="situation-label">Down</div>
            <div class="situation-value" id="downDisplay">1st</div>
          </div>
          <div class="situation-item">
            <div class="situation-label">Yards to 1st</div>
            <div class="situation-value" id="yardsToFirst">10</div>
          </div>
          <div class="situation-item">
            <div class="situation-label">Field Position</div>
            <div class="situation-value" id="fieldPosition">0</div>
          </div>
          <div class="situation-item">
            <div class="situation-label">Yards to TD</div>
            <div class="situation-value critical" id="yardsToTD">40</div>
          </div>
        </div>
        <div class="possession-info" id="possessionInfo">
          Waiting to start...
        </div>
      </div>

      <!-- Game Over Message (hidden initially) -->
      <div id="gameOver" class="game-over hidden">
        <h2 id="winnerText"></h2>
        <p>Game complete!</p>
      </div>

      <!-- Visual Field -->
      <div class="visual-field">
        <div class="field-header">Field Visualization</div>
        <div class="field-track">
          <div class="field-markers">
            <div class="field-marker"><span class="marker-label">0</span></div>
            <div class="field-marker"><span class="marker-label">10</span></div>
            <div class="field-marker"><span class="marker-label">20</span></div>
            <div class="field-marker"><span class="marker-label">30</span></div>
            <div class="field-marker"><span class="marker-label">40</span></div>
          </div>
          <div class="endzone"></div>
          <div class="first-down-marker" id="firstDownMarker"></div>
          <div class="ball-marker" id="ballMarker">üèà</div>
        </div>
      </div>

      <!-- Offense Card Selection -->
      <div class="card-section">
        <div class="section-header offense" id="offenseHeader">
          üèà OFFENSE - Player 1
        </div>
        <div class="cards-container">
          <div class="cards">
            <div class="card" onclick="selectOffenseCard('run', 'power')" id="card-run-power">
              <div class="card-header">
                <span class="card-name">Power Run</span>
                <span class="card-icon">üí™</span>
              </div>
              <div class="card-stats">Modifier: +2 | Need: 5+</div>
              <div class="card-desc">Safe but modest gain</div>
            </div>

            <div class="card" onclick="selectOffenseCard('run', 'sweep')" id="card-run-sweep">
              <div class="card-header">
                <span class="card-name">Sweep</span>
                <span class="card-icon">‚ö°</span>
              </div>
              <div class="card-stats">Modifier: +4 | Need: 7+</div>
              <div class="card-desc">Risky but explosive</div>
            </div>

            <div class="card" onclick="selectOffenseCard('pass', 'short')" id="card-pass-short">
              <div class="card-header">
                <span class="card-name">Short Pass</span>
                <span class="card-icon">üéØ</span>
              </div>
              <div class="card-stats">Modifier: +3 | Need: 6+</div>
              <div class="card-desc">Balanced approach</div>
            </div>

            <div class="card" onclick="selectOffenseCard('pass', 'deep')" id="card-pass-deep">
              <div class="card-header">
                <span class="card-name">Deep Pass</span>
                <span class="card-icon">üöÄ</span>
              </div>
              <div class="card-stats">Modifier: +6 | Need: 9+</div>
              <div class="card-desc">Home run ball!</div>
            </div>
          </div>
          <button class="ready-button offense-ready" id="offenseReadyBtn" onclick="confirmOffenseReady()" disabled>
            Select a Card
          </button>
        </div>
      </div>

      <!-- Defense Card Selection -->
      <div class="card-section">
        <div class="section-header defense" id="defenseHeader">
          üõ°Ô∏è DEFENSE - Player 2
        </div>
        <div class="cards-container">
          <div class="cards">
            <div class="card" onclick="selectDefenseCard('contain')" id="card-def-contain">
              <div class="card-header">
                <span class="card-name">Contain</span>
                <span class="card-icon">üß±</span>
              </div>
              <div class="card-stats">Defense: +3</div>
              <div class="card-desc">Solid wall, stops runs</div>
            </div>

            <div class="card" onclick="selectDefenseCard('blitz')" id="card-def-blitz">
              <div class="card-header">
                <span class="card-name">Blitz</span>
                <span class="card-icon">‚öîÔ∏è</span>
              </div>
              <div class="card-stats">Defense: +5</div>
              <div class="card-desc">All-out pressure!</div>
            </div>

            <div class="card" onclick="selectDefenseCard('coverage')" id="card-def-coverage">
              <div class="card-header">
                <span class="card-name">Coverage</span>
                <span class="card-icon">üë•</span>
              </div>
              <div class="card-stats">Defense: +4</div>
              <div class="card-desc">Locks down passes</div>
            </div>

            <div class="card" onclick="selectDefenseCard('prevent')" id="card-def-prevent">
              <div class="card-header">
                <span class="card-name">Prevent</span>
                <span class="card-icon">üö´</span>
              </div>
              <div class="card-stats">Defense: +2</div>
              <div class="card-desc">Bend don't break</div>
            </div>
          </div>
          <button class="ready-button defense-ready" id="defenseReadyBtn" onclick="confirmDefenseReady()" disabled>
            Select a Card
          </button>
        </div>
      </div>

      <button class="reset-btn" onclick="leaveGame()">üö™ Leave Game</button>

      <!-- Play Log -->
      <div class="log-container">
        <div class="log-title">üìã Play-by-Play Log</div>
        <div id="playLog"></div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURATION - REPLACE WITH YOUR API KEY
    // ========================================
    
    const BIN_ID = '698aaf20ae596e708f1f04bc';
    const API_KEY = '$2a$10$721mBXbhDM.r421Nxp27M.wEacWpLYhbQI0uA4ctGTpCx5nxi/sB.'; // <-- PUT YOUR API KEY HERE
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
    
    // Check if API key is set
    if (API_KEY === 'YOUR_API_KEY_HERE') {
      console.warn('‚ö†Ô∏è API KEY NOT SET - Multiplayer will not work until you add your JSONBin API key');
    } else {
      // Hide the notice if API key is configured
      document.getElementById('apiKeyNotice').style.display = 'none';
    }
    
    // ========================================
    // Game State
    // ========================================
    
    // Play card definitions
    const OFFENSE_CARDS = {
      run: {
        power: { name: 'Power Run', modifier: 2, minRoll: 5, icon: 'üí™' },
        sweep: { name: 'Sweep', modifier: 4, minRoll: 7, icon: '‚ö°' }
      },
      pass: {
        short: { name: 'Short Pass', modifier: 3, minRoll: 6, icon: 'üéØ' },
        deep: { name: 'Deep Pass', modifier: 6, minRoll: 9, icon: 'üöÄ' }
      }
    };

    const DEFENSE_CARDS = {
      contain: { name: 'Contain', modifier: 3, icon: 'üß±' },
      blitz: { name: 'Blitz', modifier: 5, icon: '‚öîÔ∏è' },
      coverage: { name: 'Coverage', modifier: 4, icon: 'üë•' },
      prevent: { name: 'Prevent', modifier: 2, icon: 'üö´' }
    };

    const FIELD_LENGTH = 40;
    const WINNING_SCORE = 3;
    const YARDS_FOR_FIRST_DOWN = 10;

    // Local player state
    let myPlayerNumber = null;
    let myRoomCode = null;
    let pollInterval = null;
    let selectedCardLocally = null; // Track local selection before confirming

    // Game state (synced from server)
    let gameState = {
      player1Score: 0,
      player2Score: 0,
      currentYardLine: 0,
      offensePlayer: 1,
      currentDown: 1,
      yardsToFirstDown: YARDS_FOR_FIRST_DOWN,
      firstDownLine: YARDS_FOR_FIRST_DOWN,
      gameOver: false,
      player1Card: null,
      player2Card: null,
      player1Ready: false,
      player2Ready: false,
      lastPlayResult: null,
      playLog: []
    };

    // ========================================
    // Server Communication
    // ========================================

    async function createGame() {
      if (API_KEY === 'YOUR_API_KEY_HERE') {
        alert('Please add your JSONBin API key first! See the red box above for instructions.');
        return;
      }

      // Generate 4-digit room code
      const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
      myRoomCode = roomCode;
      myPlayerNumber = 1;

      // Initialize game in JSONBin
      const initialData = await fetchBinData();
      if (!initialData.games) {
        initialData.games = {};
      }
      
      initialData.games[roomCode] = {
        player1Connected: true,
        player2Connected: false,
        gameState: {
          player1Score: 0,
          player2Score: 0,
          currentYardLine: 0,
          offensePlayer: 1,
          currentDown: 1,
          yardsToFirstDown: YARDS_FOR_FIRST_DOWN,
          firstDownLine: YARDS_FOR_FIRST_DOWN,
          gameOver: false,
          player1Card: null,
          player2Card: null,
          player1Ready: false,
          player2Ready: false,
          lastPlayResult: null,
          playLog: []
        }
      };

      await updateBinData(initialData);

      // Show room code
      document.getElementById('roomCode').textContent = roomCode;
      document.getElementById('roomCodeDisplay').classList.remove('hidden');

      // Start polling for player 2
      startPolling();
    }

    async function joinGame() {
      if (API_KEY === 'YOUR_API_KEY_HERE') {
        alert('Please add your JSONBin API key first! See the red box above for instructions.');
        return;
      }

      const roomCode = document.getElementById('joinCodeInput').value.trim();
      if (!roomCode || roomCode.length !== 4) {
        alert('Please enter a valid 4-digit room code');
        return;
      }

      myRoomCode = roomCode;
      myPlayerNumber = 2;

      // Check if game exists
      const data = await fetchBinData();
      if (!data.games || !data.games[roomCode]) {
        alert('Game not found! Check the code and try again.');
        return;
      }

      // Mark player 2 as connected
      data.games[roomCode].player2Connected = true;
      await updateBinData(data);

      // Switch to game screen
      showGameScreen();
      startPolling();
    }

    async function fetchBinData() {
      try {
        const response = await fetch(API_URL + '/latest', {
          headers: {
            'X-Master-Key': API_KEY
          }
        });
        const result = await response.json();
        return result.record || { games: {} };
      } catch (error) {
        console.error('Error fetching data:', error);
        return { games: {} };
      }
    }

    async function updateBinData(data) {
      try {
        const response = await fetch(API_URL, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': API_KEY
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          console.error('Failed to update bin:', await response.text());
        }
      } catch (error) {
        console.error('Error updating data:', error);
      }
    }

    function startPolling() {
      // Poll every 1 second
      pollInterval = setInterval(async () => {
        const data = await fetchBinData();
        const room = data.games?.[myRoomCode];
        
        if (!room) return;

        // Check if both players connected
        if (room.player1Connected && room.player2Connected) {
          showGameScreen();
        }

        // Update game state
        gameState = room.gameState;
        updateUI();

        // Auto-execute play if both players ready
        if (gameState.player1Ready && gameState.player2Ready && !gameState.gameOver) {
          if (myPlayerNumber === 1) {
            // Only player 1 executes to avoid double execution
            await executePlay();
          }
        }
      }, 1000);
    }

    function showGameScreen() {
      document.getElementById('lobbyScreen').classList.add('hidden');
      document.getElementById('gameScreen').classList.remove('hidden');
      
      // Update player labels
      if (myPlayerNumber === 1) {
        document.getElementById('player1Label').textContent = 'You';
        document.getElementById('player2Label').textContent = 'Opponent';
      } else {
        document.getElementById('player1Label').textContent = 'Opponent';
        document.getElementById('player2Label').textContent = 'You';
      }

      addLog('üéÆ Game started! Player 1 is offense, Player 2 is defense.');
      addLog('üèà 4 downs to get 10 yards. First to 3 TDs wins!');
    }

    function leaveGame() {
      if (pollInterval) {
        clearInterval(pollInterval);
      }
      
      // Reload page to go back to lobby
      location.reload();
    }

    // ========================================
    // Card Selection
    // ========================================

    function selectOffenseCard(playType, cardType) {
      if (gameState.gameOver) return;
      if (myPlayerNumber !== gameState.offensePlayer) return;
      if (gameState.player1Ready) return; // Already confirmed

      // Deselect all offense cards
      document.querySelectorAll('[id^="card-run-"], [id^="card-pass-"]').forEach(card => {
        card.classList.remove('selected');
      });

      // Select the chosen card
      document.getElementById(`card-${playType}-${cardType}`).classList.add('selected');
      selectedCardLocally = { playType, cardType };

      // Enable ready button
      const readyBtn = document.getElementById('offenseReadyBtn');
      readyBtn.disabled = false;
      readyBtn.textContent = '‚úÖ I\'m Ready!';
    }

    function selectDefenseCard(cardType) {
      if (gameState.gameOver) return;
      const defensePlayer = gameState.offensePlayer === 1 ? 2 : 1;
      if (myPlayerNumber !== defensePlayer) return;
      if (gameState.player2Ready) return; // Already confirmed

      // Deselect all defense cards
      document.querySelectorAll('[id^="card-def-"]').forEach(card => {
        card.classList.remove('selected');
      });

      // Select the chosen card
      document.getElementById(`card-def-${cardType}`).classList.add('selected');
      selectedCardLocally = { cardType };

      // Enable ready button
      const readyBtn = document.getElementById('defenseReadyBtn');
      readyBtn.disabled = false;
      readyBtn.textContent = '‚úÖ I\'m Ready!';
    }

    async function confirmOffenseReady() {
      if (!selectedCardLocally) return;

      // Update server
      const data = await fetchBinData();
      data.games[myRoomCode].gameState.player1Card = selectedCardLocally;
      data.games[myRoomCode].gameState.player1Ready = true;
      await updateBinData(data);

      // Update button
      const readyBtn = document.getElementById('offenseReadyBtn');
      readyBtn.classList.add('confirmed');
      readyBtn.disabled = true;
      readyBtn.textContent = '‚úì Ready! Waiting for defense...';
    }

    async function confirmDefenseReady() {
      if (!selectedCardLocally) return;

      // Update server
      const data = await fetchBinData();
      data.games[myRoomCode].gameState.player2Card = selectedCardLocally;
      data.games[myRoomCode].gameState.player2Ready = true;
      await updateBinData(data);

      // Update button
      const readyBtn = document.getElementById('defenseReadyBtn');
      readyBtn.classList.add('confirmed');
      readyBtn.disabled = true;
      readyBtn.textContent = '‚úì Ready! Waiting for offense...';
    }

    // ========================================
    // Utility Functions
    // ========================================

    function rollDice() {
      const die1 = Math.floor(Math.random() * 6) + 1;
      const die2 = Math.floor(Math.random() * 6) + 1;
      return [die1, die2];
    }

    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    function getDownString(down) {
      const suffixes = ['th', 'st', 'nd', 'rd'];
      const v = down % 100;
      return down + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
    }

    function addLog(message, type = 'normal') {
      const logDiv = document.getElementById('playLog');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      
      if (type === 'touchdown') {
        entry.classList.add('touchdown');
      } else if (type === 'drive-end') {
        entry.classList.add('drive-end');
      } else if (type === 'first-down') {
        entry.classList.add('first-down');
      }
      
      entry.textContent = message;
      logDiv.insertBefore(entry, logDiv.firstChild);
    }

    function updateBallPosition() {
      const ball = document.getElementById('ballMarker');
      const percentage = (gameState.currentYardLine / FIELD_LENGTH) * 100;
      ball.style.left = `${percentage}%`;
    }

    function updateFirstDownMarker() {
      const marker = document.getElementById('firstDownMarker');
      const percentage = (gameState.firstDownLine / FIELD_LENGTH) * 100;
      marker.style.left = `${percentage}%`;
    }

    function updateSituationBoard() {
      document.getElementById('downDisplay').textContent = getDownString(gameState.currentDown);
      document.getElementById('yardsToFirst').textContent = gameState.yardsToFirstDown;
      document.getElementById('fieldPosition').textContent = gameState.currentYardLine;
      document.getElementById('yardsToTD').textContent = FIELD_LENGTH - gameState.currentYardLine;
      
      const offensePlayerLabel = gameState.offensePlayer === myPlayerNumber ? 'You' : 'Opponent';
      document.getElementById('possessionInfo').textContent = 
        `${offensePlayerLabel} on offense`;
    }

    function updateUI() {
      document.getElementById('score1').textContent = gameState.player1Score;
      document.getElementById('score2').textContent = gameState.player2Score;
      
      // Update headers
      document.getElementById('offenseHeader').textContent = 
        `üèà OFFENSE - ${gameState.offensePlayer === myPlayerNumber ? 'YOU' : 'OPPONENT'}`;
      const defensePlayer = gameState.offensePlayer === 1 ? 2 : 1;
      document.getElementById('defenseHeader').textContent = 
        `üõ°Ô∏è DEFENSE - ${defensePlayer === myPlayerNumber ? 'YOU' : 'OPPONENT'}`;

      // Highlight my role
      document.getElementById('offenseHeader').classList.toggle('my-role', gameState.offensePlayer === myPlayerNumber);
      document.getElementById('defenseHeader').classList.toggle('my-role', defensePlayer === myPlayerNumber);

      updateBallPosition();
      updateFirstDownMarker();
      updateSituationBoard();
      updateCardStates();
      updateReadyButtons();
      updateStatusMessage();

      // Check for game over
      if (gameState.gameOver) {
        const winner = gameState.player1Score >= WINNING_SCORE ? 1 : 2;
        const winnerLabel = winner === myPlayerNumber ? 'You Win!' : 'Opponent Wins!';
        document.getElementById('winnerText').textContent = winnerLabel;
        document.getElementById('gameOver').classList.remove('hidden');
      }
    }

    function updateCardStates() {
      const isOffense = myPlayerNumber === gameState.offensePlayer;
      const isDefense = !isOffense;

      // Enable/disable offense cards
      document.querySelectorAll('[id^="card-run-"], [id^="card-pass-"]').forEach(card => {
        if (isOffense && !gameState.gameOver && !gameState.player1Ready) {
          card.classList.remove('disabled');
        } else {
          card.classList.add('disabled');
        }
      });

      // Enable/disable defense cards
      document.querySelectorAll('[id^="card-def-"]').forEach(card => {
        if (isDefense && !gameState.gameOver && !gameState.player2Ready) {
          card.classList.remove('disabled');
        } else {
          card.classList.add('disabled');
        }
      });
    }

    function updateReadyButtons() {
      const offenseBtn = document.getElementById('offenseReadyBtn');
      const defenseBtn = document.getElementById('defenseReadyBtn');

      // Reset buttons if new play
      if (!gameState.player1Ready && !gameState.player2Ready) {
        selectedCardLocally = null;
        
        offenseBtn.classList.remove('confirmed');
        offenseBtn.disabled = true;
        offenseBtn.textContent = 'Select a Card';
        
        defenseBtn.classList.remove('confirmed');
        defenseBtn.disabled = true;
        defenseBtn.textContent = 'Select a Card';

        // Clear selections
        document.querySelectorAll('.card').forEach(card => {
          card.classList.remove('selected');
        });
      }

      // Update based on ready states
      if (gameState.player1Ready) {
        offenseBtn.classList.add('confirmed');
        offenseBtn.disabled = true;
        offenseBtn.textContent = '‚úì Ready! Waiting for defense...';
      }

      if (gameState.player2Ready) {
        defenseBtn.classList.add('confirmed');
        defenseBtn.disabled = true;
        defenseBtn.textContent = '‚úì Ready! Waiting for offense...';
      }

      if (gameState.player1Ready && gameState.player2Ready) {
        offenseBtn.textContent = '‚ö° Executing Play...';
        defenseBtn.textContent = '‚ö° Executing Play...';
      }
    }

    function updateStatusMessage() {
      const statusEl = document.getElementById('statusMessage');
      
      if (gameState.gameOver) {
        statusEl.classList.add('hidden');
        return;
      }

      const isOffense = myPlayerNumber === gameState.offensePlayer;
      const myReady = isOffense ? gameState.player1Ready : gameState.player2Ready;
      const opponentReady = isOffense ? gameState.player2Ready : gameState.player1Ready;

      if (myReady && opponentReady) {
        statusEl.textContent = '‚ö° Both players ready! Executing play...';
        statusEl.classList.remove('hidden', 'waiting');
      } else if (myReady && !opponentReady) {
        statusEl.textContent = '‚úÖ Waiting for opponent to confirm...';
        statusEl.classList.remove('hidden');
        statusEl.classList.add('waiting');
      } else if (!myReady && opponentReady) {
        statusEl.textContent = '‚è≥ Opponent is ready! Your turn...';
        statusEl.classList.remove('hidden');
        statusEl.classList.add('waiting');
      } else {
        statusEl.classList.add('hidden');
      }
    }

    // ========================================
    // Play Execution
    // ========================================

    async function executePlay() {
      if (!gameState.player1Card || !gameState.player2Card) return;
      if (!gameState.player1Ready || !gameState.player2Ready) return;
      if (gameState.gameOver) return;

      const offenseCard = OFFENSE_CARDS[gameState.player1Card.playType][gameState.player1Card.cardType];
      const defenseCard = DEFENSE_CARDS[gameState.player2Card.cardType];

      // Roll dice
      const [die1, die2] = rollDice();
      const diceTotal = die1 + die2;

      // Calculate yards
      const rawYards = diceTotal + offenseCard.modifier - defenseCard.modifier;
      const yards = clamp(rawYards, 0, FIELD_LENGTH);

      // Log the play
      addLog(`${getDownString(gameState.currentDown)} & ${gameState.yardsToFirstDown}: ${offenseCard.icon} ${offenseCard.name} vs ${defenseCard.icon} ${defenseCard.name}`);
      addLog(`Rolled ${die1}+${die2}=${diceTotal} | +${offenseCard.modifier} OFF | -${defenseCard.modifier} DEF | Net: ${rawYards} yards`);

      let newGameState = { ...gameState };

      // Check if minimum roll was met
      if (diceTotal < offenseCard.minRoll) {
        addLog(`‚ö†Ô∏è Roll too low! Needed ${offenseCard.minRoll}+ but got ${diceTotal}. Play failed!`);
        newGameState.currentDown++;
        
        if (newGameState.currentDown > 4) {
          addLog(`--- TURNOVER ON DOWNS: Player ${newGameState.offensePlayer === 1 ? 2 : 1} now on offense ---`, 'drive-end');
          newGameState.offensePlayer = newGameState.offensePlayer === 1 ? 2 : 1;
          newGameState.currentYardLine = 0;
          newGameState.currentDown = 1;
          newGameState.yardsToFirstDown = YARDS_FOR_FIRST_DOWN;
          newGameState.firstDownLine = YARDS_FOR_FIRST_DOWN;
        }
      } else if (rawYards <= 0) {
        addLog('Defense stuffed the play! No gain.');
        newGameState.currentDown++;
        
        if (newGameState.currentDown > 4) {
          addLog(`--- TURNOVER ON DOWNS: Player ${newGameState.offensePlayer === 1 ? 2 : 1} now on offense ---`, 'drive-end');
          newGameState.offensePlayer = newGameState.offensePlayer === 1 ? 2 : 1;
          newGameState.currentYardLine = 0;
          newGameState.currentDown = 1;
          newGameState.yardsToFirstDown = YARDS_FOR_FIRST_DOWN;
          newGameState.firstDownLine = YARDS_FOR_FIRST_DOWN;
        }
      } else {
        // Successful play
        newGameState.currentYardLine = Math.min(newGameState.currentYardLine + yards, FIELD_LENGTH);
        newGameState.yardsToFirstDown -= yards;
        
        addLog(`‚úÖ Gained ${yards} yards! Now at ${newGameState.currentYardLine} yard line.`);

        // Check for touchdown
        if (newGameState.currentYardLine >= FIELD_LENGTH) {
          if (newGameState.offensePlayer === 1) {
            newGameState.player1Score++;
          } else {
            newGameState.player2Score++;
          }
          
          addLog(`üèÜ TOUCHDOWN! Player ${newGameState.offensePlayer} scores! (Score: ${newGameState.player1Score}-${newGameState.player2Score})`, 'touchdown');

          if (newGameState.player1Score >= WINNING_SCORE || newGameState.player2Score >= WINNING_SCORE) {
            newGameState.gameOver = true;
            const winner = newGameState.player1Score >= WINNING_SCORE ? 1 : 2;
            addLog(`üéâ GAME OVER: Player ${winner} wins ${newGameState.player1Score}-${newGameState.player2Score}!`, 'touchdown');
          } else {
            newGameState.offensePlayer = newGameState.offensePlayer === 1 ? 2 : 1;
            newGameState.currentYardLine = 0;
            newGameState.currentDown = 1;
            newGameState.yardsToFirstDown = YARDS_FOR_FIRST_DOWN;
            newGameState.firstDownLine = YARDS_FOR_FIRST_DOWN;
            addLog(`--- Player ${newGameState.offensePlayer} now on offense ---`, 'drive-end');
          }
        } 
        else if (newGameState.yardsToFirstDown <= 0) {
          addLog(`üéØ FIRST DOWN! Chains reset.`, 'first-down');
          newGameState.currentDown = 1;
          newGameState.yardsToFirstDown = YARDS_FOR_FIRST_DOWN;
          newGameState.firstDownLine = Math.min(newGameState.currentYardLine + YARDS_FOR_FIRST_DOWN, FIELD_LENGTH);
        } 
        else {
          newGameState.currentDown++;
          
          if (newGameState.currentDown > 4) {
            addLog(`--- TURNOVER ON DOWNS: Player ${newGameState.offensePlayer === 1 ? 2 : 1} now on offense ---`, 'drive-end');
            newGameState.offensePlayer = newGameState.offensePlayer === 1 ? 2 : 1;
            newGameState.currentYardLine = 0;
            newGameState.currentDown = 1;
            newGameState.yardsToFirstDown = YARDS_FOR_FIRST_DOWN;
            newGameState.firstDownLine = YARDS_FOR_FIRST_DOWN;
          }
        }
      }

      // Clear cards and ready states
      newGameState.player1Card = null;
      newGameState.player2Card = null;
      newGameState.player1Ready = false;
      newGameState.player2Ready = false;

      // Update server
      const data = await fetchBinData();
      data.games[myRoomCode].gameState = newGameState;
      await updateBinData(data);

      // Update local state
      gameState = newGameState;
      updateUI();
    }

    // ========================================
    // Initialize
    // ========================================

    window.onload = function() {
      // Nothing to do - waiting for user to create/join
    };
  </script>
</body>
</html>